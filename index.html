<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#243b9f">

<title>Block Puzzle Studio PRO</title>

<style>
:root{
  --bg:#243b9f;
  --board:#1b2b7a;
  --cell:#15205c;
}
body{
  margin:0;
  background:var(--bg);
  color:white;
  font-family:Arial;
  display:flex;
  flex-direction:column;
  align-items:center;
  overflow:hidden;
  touch-action:none;
  user-select:none;
}
h2{margin:8px 0 4px;font-size:20px}

#top{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  justify-content:center;
  margin-bottom:8px;
}
.box{
  background:var(--board);
  padding:7px 10px;
  border-radius:10px;
  font-weight:bold;
  font-size:14px;
}

#board{
  display:grid;
  grid-template-columns:repeat(10,34px);
  grid-template-rows:repeat(10,34px);
  gap:2px;
  background:var(--board);
  padding:6px;
  border-radius:12px;
  position:relative;
}
.cell{
  width:34px;height:34px;
  background:var(--cell);
  border-radius:5px;
  transition:.1s;
}
.preview{opacity:.45;}
.flash{animation:flash .22s;}
@keyframes flash{50%{transform:scale(1.18)}}

#pieces{margin-top:14px;display:flex;gap:14px;}
.piece{display:grid;gap:2px;touch-action:none;}
.block{width:30px;height:30px;border-radius:4px;}
.dragging{
  position:fixed!important;
  pointer-events:none;
  z-index:99;
  transform:scale(1.12);
}

/* combo text */
.comboText{
  position:absolute;
  left:50%;
  top:45%;
  transform:translate(-50%,-50%);
  font-size:28px;
  font-weight:bold;
  color:#ffd42a;
  animation:comboPop .7s forwards;
  pointer-events:none;
}
@keyframes comboPop{
  0%{opacity:0;transform:translate(-50%,-30%) scale(.5);}
  30%{opacity:1;transform:translate(-50%,-60%) scale(1.2);}
  100%{opacity:0;transform:translate(-50%,-120%) scale(1);}
}

#overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.65);
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
}
button{
  margin-top:10px;
  padding:10px 20px;
  border:none;
  border-radius:10px;
  background:#ffd42a;
  font-weight:bold;
}
</style>
</head>
<body>

<h2>BLOCK PUZZLE — STUDIO PRO</h2>

<div id="top">
  <div class="box" id="score">Điểm: 0</div>
  <div class="box" id="best">Best: 0</div>
  <div class="box" id="combo">Combo: x1</div>
  <div class="box" id="rank">Rank: Bronze</div>
</div>

<div id="board"></div>
<div id="pieces"></div>

<div id="overlay">
  <h1>START GAME</h1>
  <button onclick="startGame()">BẮT ĐẦU</button>
</div>

<script>
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("service-worker.js");
}

const SIZE=10;
const COLORS=["#ffd42a","#58e058","#ff6b4a","#6aaeff","#c86cff"];
const SHAPES=[
 [[1,1],[1,1]],
 [[1,1,1]],
 [[1],[1],[1]],
 [[1,0],[1,1]],
 [[0,1],[1,1]],
 [[1,1,1,1]]
];

const board=[];
const boardEl=document.getElementById("board");
const piecesEl=document.getElementById("pieces");
const overlay=document.getElementById("overlay");

let score=0;
let combo=1;
let best=localStorage.getItem("proBest")||0;

document.getElementById("best").innerText="Best: "+best;

function getRank(s){
  if(s>2500) return "Diamond";
  if(s>1500) return "Gold";
  if(s>700) return "Silver";
  return "Bronze";
}

function updateRank(){
  document.getElementById("rank").innerText="Rank: "+getRank(score);
}

function createBoard(){
  boardEl.innerHTML="";
  for(let y=0;y<SIZE;y++){
    board[y]=[];
    for(let x=0;x<SIZE;x++){
      board[y][x]=0;
      const c=document.createElement("div");
      c.className="cell";
      c.dataset.x=x;c.dataset.y=y;
      boardEl.appendChild(c);
    }
  }
}
function renderBoard(){
  document.querySelectorAll(".cell").forEach(c=>{
    const x=c.dataset.x,y=c.dataset.y;
    c.style.background=board[y][x]||"var(--cell)";
  });
}

function randomShape(){
  return SHAPES[Math.floor(Math.random()*SHAPES.length)];
}

function createPieces(){
  piecesEl.innerHTML="";
  for(let i=0;i<3;i++){
    const shape=randomShape();
    const color=COLORS[Math.floor(Math.random()*COLORS.length)];

    const p=document.createElement("div");
    p.className="piece";
    p.shape=shape;
    p.color=color;
    p.style.gridTemplateColumns=`repeat(${shape[0].length},30px)`;

    shape.forEach(r=>{
      r.forEach(v=>{
        const b=document.createElement("div");
        b.className="block";
        b.style.background=v?color:"transparent";
        if(!v) b.style.visibility="hidden";
        p.appendChild(b);
      });
    });

    enableDrag(p);
    piecesEl.appendChild(p);
  }
}

function enableDrag(piece){
  piece.addEventListener("pointerdown", e=>{
    e.preventDefault();
    piece.classList.add("dragging");

    function move(ev){
      piece.style.left=(ev.clientX-40)+"px";
      piece.style.top=(ev.clientY-40)+"px";
      showPreview(piece.shape,ev.clientX,ev.clientY,piece.color);
    }

    function up(ev){
      hidePreview();
      const pos=getPos(ev.clientX,ev.clientY);

      if(pos && canPlace(piece.shape,pos.x,pos.y)){
        place(piece.shape,pos.x,pos.y,piece.color);
        renderBoard();
        clearLines();
        piece.remove();

        if(piecesEl.children.length===0){
          createPieces();
          if(!hasMove()) gameOver();
        }
      }

      piece.classList.remove("dragging");
      piece.style.left="";
      piece.style.top="";

      window.removeEventListener("pointermove",move);
      window.removeEventListener("pointerup",up);
    }

    window.addEventListener("pointermove",move);
    window.addEventListener("pointerup",up);
  });
}

function getPos(cx,cy){
  const r=boardEl.getBoundingClientRect();
  if(cx<r.left||cy<r.top||cx>r.right||cy>r.bottom) return null;
  return {x:Math.floor((cx-r.left)/36),y:Math.floor((cy-r.top)/36)};
}
function canPlace(shape,px,py){
  for(let y=0;y<shape.length;y++)
    for(let x=0;x<shape[y].length;x++)
      if(shape[y][x]){
        let bx=px+x,by=py+y;
        if(bx<0||bx>=SIZE||by<0||by>=SIZE) return false;
        if(board[by][bx]) return false;
      }
  return true;
}
function place(shape,px,py,color){
  shape.forEach((r,y)=>r.forEach((v,x)=>{
    if(v) board[py+y][px+x]=color;
  }));
}

function showPreview(shape,cx,cy,color){
  hidePreview();
  const pos=getPos(cx,cy);
  if(!pos || !canPlace(shape,pos.x,pos.y)) return;

  shape.forEach((row,y)=>{
    row.forEach((v,x)=>{
      if(v){
        const c=document.querySelector(
          `.cell[data-x="${pos.x+x}"][data-y="${pos.y+y}"]`
        );
        if(c){
          c.style.background=color;
          c.classList.add("preview");
        }
      }
    });
  });
}
function hidePreview(){
  document.querySelectorAll(".preview").forEach(c=>{
    c.classList.remove("preview");
    const x=c.dataset.x,y=c.dataset.y;
    c.style.background=board[y][x]||"var(--cell)";
  });
}

function showComboText(txt){
  const t=document.createElement("div");
  t.className="comboText";
  t.innerText=txt;
  boardEl.appendChild(t);
  setTimeout(()=>t.remove(),700);
}

function clearLines(){
  let cleared=0;
  const cells=document.querySelectorAll(".cell");

  for(let y=0;y<SIZE;y++){
    if(board[y].every(v=>v)){ board[y].fill(0); cleared++; }
  }
  for(let x=0;x<SIZE;x++){
    let full=true;
    for(let y=0;y<SIZE;y++) if(!board[y][x]) full=false;
    if(full){ for(let y=0;y<SIZE;y++) board[y][x]=0; cleared++; }
  }

  if(cleared){
    combo++;
    score += cleared*10*combo;
    showComboText("x"+combo);
    cells.forEach(c=>c.classList.add("flash"));
    setTimeout(()=>cells.forEach(c=>c.classList.remove("flash")),220);
  }else combo=1;

  document.getElementById("score").innerText="Điểm: "+score;
  document.getElementById("combo").innerText="Combo: x"+combo;

  if(score>best){
    best=score;
    localStorage.setItem("proBest",best);
    document.getElementById("best").innerText="Best: "+best;
  }

  updateRank();
  renderBoard();
}

function hasMove(){
  for(let p of piecesEl.children)
    for(let y=0;y<SIZE;y++)
      for(let x=0;x<SIZE;x++)
        if(canPlace(p.shape,x,y)) return true;
  return false;
}

function startGame(){
  overlay.style.display="none";
  createPieces();
}
function gameOver(){
  overlay.style.display="flex";
  overlay.innerHTML=`
    <h1>GAME OVER</h1>
    <p>Điểm: ${score}</p>
    <button onclick="restart()">CHƠI LẠI</button>
  `;
}
function restart(){
  score=0; combo=1;
  document.getElementById("score").innerText="Điểm: 0";
  document.getElementById("combo").innerText="Combo: x1";
  updateRank();

  createBoard();
  renderBoard();

  overlay.innerHTML=`
    <h1>START GAME</h1>
    <button onclick="startGame()">BẮT ĐẦU</button>
  `;
  overlay.style.display="flex";
}

createBoard();
renderBoard();
updateRank();
</script>
</body>
</html>
